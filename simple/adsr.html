<script>
const vol = document.getElementById('vol');
const toggle = document.getElementById('adsrToggle');
const ctx = new AudioContext();
const gain = ctx.createGain();
gain.connect(ctx.destination);

// ADSR (in seconds, sustain as 0-1)
const env = { a: 0.1, d: 0.2, s: 0.7, r: 0.5 };

// Track current note to stop it when a new one plays
let currentSrc = null;

vol.addEventListener('input', () => {
gain.gain.value = vol.value; // Update master gain
});

function play() {
if (!pianoSamples.length) return;

// Stop current note if playing
if (currentSrc) {
currentSrc.stop(0);
currentSrc = null;
}

const i = Math.floor(Math.random() * pianoSamples.length);
const src = ctx.createBufferSource();
src.buffer = pianoSamples[i];
src.playbackRate.value = 2 ** (pitchShift / 12);
src.connect(gain);
currentSrc = src;

const t = ctx.currentTime;
const v = vol.value;

if (toggle.checked) {
// ADSR envelope
gain.gain.cancelScheduledValues(t);
gain.gain.setValueAtTime(0, t);
gain.gain.linearRampToValueAtTime(v, t + env.a);
gain.gain.linearRampToValueAtTime(v * env.s, t + env.a + env.d);

src.start(t);
src.stop(t + env.a + env.d + 2); // Fixed note length

src.onended = () => {
gain.gain.cancelScheduledValues(ctx.currentTime);
gain.gain.setValueAtTime(gain.gain.value, ctx.currentTime);
gain.gain.linearRampToValueAtTime(0, ctx.currentTime + env.r);
if (currentSrc === src) currentSrc = null;
};
} else {
// Full sound, no ADSR
gain.gain.cancelScheduledValues(t);
gain.gain.setValueAtTime(v, t); // Constant volume
src.start(t);
src.onended = () => {
if (currentSrc === src) currentSrc = null;
};
}
}
</script>